---
title: "Applied Category Theory with Scryer Prolog and CLP(ℤ): a case study in dose-escalation"
subtitle: "Scryer Prolog Meetup 2024 --- Hotel Stefanie, Vienna"
author: "David C. Norris"
filters:
  - diagram
format:
  revealjs:
    embed-resources: true
    auto-stretch: false
diagram:
  engine:
    tikz:
      execpath: pdflatex
      header-includes:
        - '\usepackage[mathscr]{eucal}'
        - '\usepackage{amsmath}'
        - '\usepackage{amssymb}'
        - '\usepackage{mathtools}'
        - '\usepackage{tikz}'
        - '\usepackage{tikz-cd}'
        - '\usetikzlibrary{shapes}'
        - '\newcommand{\D}{\mathcal{D}}'
        - '\newcommand{\Q}{\mathcal{Q}}'
---

## An update

::: hidden
\newcommand{\N}{\mathbb{N}}
\newcommand{\R}{\mathbb{R}}
\renewcommand{\S}{\mathcal{S}}
\newcommand{\A}{\mathcal{A}}
\newcommand{\C}{\mathcal{C}}
\newcommand{\D}{\mathcal{D}}
\newcommand{\Q}{\mathcal{Q}}
\newcommand{\M}{\mathcal{M}}
\newcommand{\IE}{\Q \xrightarrow{\;\;E\;\;} \D}
\newcommand{\E}{\widehat{E}}
\newcommand{\delihat}{\surd\E}
:::

![Norris & Triska (2024)](Executable-Spec-arXiv-2024.png)

# Orientation to oncology dose-finding

Inertial forces of history

## Up-and-down designs in explosives research

![Example of data from an up-and-down design in explosives research.  Source: Dixon & Mood (1948) "A Method for Obtaining and Analyzing Sensitivity Data" *J. Am. Stat. Assoc.*](Dixon-Mood-Fig1.png)

## 'Sensitivity data' are conceived as inherently *censored*

![](Dixon-Mood-sensitivity-def.png)

## Ethical assumptions

* Typically, dose-finding trials are 'first-in-humans' (FIH) trials

* Oncology drugs are too toxic for healthy-volunteer studies

* So FIH oncology trials are pursued with *therapeutic intent*,
  in patients who have exhausted all standard treatments
  
* Nevertheless, *scientifically* the emphasis in dose-finding trials
  is primarily on toxicity, rather than efficacy

* Thus, participants are "resources" [*sic* --- as recent as 2023!]
  used for learning about drug toxicities

## Statistical assumptions

* Occurrence of a binary 'dose-limiting toxicity' (DLT) is recorded
  after a 'first cycle' of treatment, typically 4 weeks

* A DLT is akin to the explosions of Dixon & Mood

* Each trial participant yields one Bernoulli trial, DLT=0|1

* These are *exchangeable* (participants lack individuality)

* Trial concludes with a 'recommended phase 2 dose' (RP2D)

::: aside
The DTAT research programme rejects many of the foregoing
assumptions, aiming to enable clinical *dose individualization*.
:::

## Pharmacologic assumptions

> Alle Dinge sind Gift, und nichts ist ohne Gift;
> allein die Dosis macht, dass ein Ding kein Gift ist.
> 
> --- Paracelsus, 1538

* Strictly monotone dose-response
* Higher doses are both more efficacious and more toxic


# The '3 + 3' design

The Original Sin of oncology dose finding

## 3 + 3 by example

```{.verbatim code-line-numbers="1-4|6-9|11-14|"}
Level 3                        x x o  |  2/3  <-- Too toxic 
Level 2          o x o  o o o         |  1/6  <-- MTD = RP2D
Level 1   o o o                       |  0/3
Cohort#     1      2      3      4    | Tally 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Level 3                 x x o         |  2/3  <-- Too toxic 
Level 2          o o o         o x o  |  1/6  <-- MTD = RP2D
Level 1   o o o                       |  0/3
Cohort#     1      2      3      4    | Tally
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Level 3                        |
Level 2          x o x         |  2/3  <-- Too toxic 
Level 1   o o o         o o o  |  0/6  <-- MTD = RP2D
Cohort#     1      2      3    | Tally
```

::: {.incremental}
- 'Markov property'
- Synchronous cohorts
:::

## 'Markov property'

![The 'Markov' or 'lack-of-memory' property of 3+3 method as described by Clertant & O'Quigley (2017) "Semiparametric dose finding methods" *J. R. Statist. Soc. B*](Clertant+O'Quigley-2017.png)


## Synchronously dosed cohorts
::: {layout-ncol=2}

![Callaway & Butler (2016) "Researchers question design of fatal French clinical trial" *Nature*](Callaway+Butler-2016-Nature.png){.lightbox}

![Wadman (2006) "London's disastrous drug trial has serious side effects for research" *Nature*](TeGenero.png){.lightbox}
:::

---

:::: {.columns}

::: {.column width="70%"}
![](Skolnik08-Table1.png){.lightbox}
:::

::: {.column width="30%"}
Note the fine print!
:::

::::


::: aside
Skolnik JM, Barrett JS, Jayaraman B, Patel D, Adamson PC. Shortening the timeline of pediatric phase I trials: the rolling six design. *J Clin Oncol.* 2008;26(2):190-195. doi:10.1200/JCO.2007.12.7712
:::

---

:::: {.columns}

::: {.column width="50%"}
![](Frankel20-Table1.png){.lightbox}
:::

::: {.column width="50%"}
Frankel PH, Chung V, Tuscano J, et al. Model of a Queuing Approach for Patient Accrual in Phase 1 Oncology Studies. *JAMA Network Open.* 2020;3(5):e204787-e204787. doi:10.1001/jamanetworkopen.2020.4787

Drowning in a combinatorial explosion of fine print?

:::

::::


## 93 final tallies of the 3-dose 3+3 {.scrollable}

![](hasse3.png){width=80% .lightbox}

## 29 final tallies of the 2-dose 3+3 {.scrollable}

![](hasse2.svg){width=100%}

---

> What can you do with it?
> It's like a lot of yaks jumping about!
> 
> --- Sir Thomas Beecham, on Beethoven's 7th Symphony

## Metagraphs

- *Objects* $a, b, c, ...$
- *Arrows* $f, g, h, ...$
- Operations *Domain* and *Codomain* assigning objects $a = \mathrm{dom} f$ and $b = \mathrm{cod} f$ to each arrow $f$,
  a situation we can depict as
  $$
  a \xrightarrow{f} b.
  $$

::: aside
Saunders Mac Lane. 1998. *Categories for the Working Mathematician.* 2ed.
:::

## Metacategories have in addition ..

- *Identity* operation $\mathrm{id}$ giving an arrow $a \xrightarrow{\mathrm{id}_a} a$ for each $a$
- *Composition* giving for each pair $\langle f, g \rangle$ with $\mathrm{dom}f = \mathrm{cod}g$ an $f \circ g$ such that
``` {.tikz}
%%| width: 100%
%%| height: 40%
\begin{tikzcd}
    a \ar[rrr, "k\circ(g\circ f) = (k\circ g)\circ f"]
    \ar[ddrrr, near end, "g\circ f"{description}]
    \ar[dd, "f"']
    & & & d
    \\ \\
    b \ar[rrr, "g"']
    \ar[uurrr, near end, "k\circ g"{description}]
    & & & c \ar[uu, "k"']
\end{tikzcd}\qquad\text{and}\qquad
\begin{tikzcd}
    a \ar[ddrr, "f"'] \ar[rr, "f"] & & b \ar[dd, "1_b"] \ar[ddrr, "g"]
    \\ \\
    & & b \ar[rr, "g"'] & & c
\end{tikzcd}
```

::: aside
Saunders Mac Lane. 1998. *Categories for the Working Mathematician*, 2ed. pp.7--8
:::


## Category

An interpretation of the preceding axioms within set theory.

![The category **3**](IMG_0328.JPG){width=80%}

## Concrete Categories

* **Set:** sets are the objects, and functions are the arrows

* **Rel:** sets and binary relations

* **Top:** topological spaces and continuous functions

* **Group:** groups and group homomorphisms

* **Poset:** partially ordered sets and monotone maps

## Abstract Categories

* **Monoid:** a category with 1 object
  - Same as a *semigroup with unit*
  - A monoid with inverses is a *group*

* **Preorder:** for any pair $\langle a, b \rangle$, there is *at most* 1 arrow $a \rightarrow b$
  - The arrows $a \rightarrow b$ are often written $a \le b$
  - This definition allows both $a \le b\;$ and $\;b \le a$
  - In a *partial order*, $a \le b \wedge b \le a \Rightarrow a = b$
  - Identity arrows $\Rightarrow$ reflexivity; composition $\Rightarrow$ transitivity

## Dosewise Tallies

```prolog
:- use_module(library(clpz)).
clpz:monotonic.

q_r(T/N, T:U) :- 0 #=< #T, 0 #=< #U, #N #= #T + #U.
```

Denote the set of *dosewise tallies* by
$$
Q = \{t/n \mid t, n \in \N, t \le n\}
$$
or in 'ratio form'
$$
R = \{t\!:\!u \mid t, u \in \N\},
$$
with $u = n - t$ denoting counts of non-toxicities.


## Q is a commutative monoid

$$
\frac{t_1}{n_1} + \frac{t_2}{n_2} = \frac{t_1+t_2}{n_1+n_2},
$$

Observe that $\frac{0}{0} \in Q$ is the unit.

$$
(Q,0/0,+) \cong (\N,0,+)\times(\N,0,+)
$$

## An *evident safety* relation on Q

Let $\preceq$ be the transitive closure of a preorder relation satisfying,
\begin{equation}
    \frac{t}{n}\!+\!\frac{1}{1} \;\preceq\; \frac{t}{n} \;\preceq\; \frac{t}{n}\!+\!\frac{0}{1} \quad \forall\; \frac{t}{n} \in Q.
\end{equation}
    Then the preorder $(Q,\preceq)$ compares the **evident safety** expressed in dosewise tallies, such that we read
$$
q_1 \preceq q_2
$$
as "$q_1$ is evidently no safer than $q_2$" or "$q_2$ is evidently at least as safe as $q_1$".

---

### $(Q,\preceq,\frac{0}{0},+)$ is a monoidal preorder

In particular, we have the *monotonicity condition*,
$$
q \preceq q',\; g \preceq g' \implies q + g \preceq q' + g',
$$
arising by induction from the our definition of $\preceq$ in terms of $+$.

* Indeed, it is a *symmetric* monoidal preorder, since $+$ is commutative!

## Characterization of $\preceq$ on $R$

$$
t\!:\!u \preceq t'\!:\!u' \iff t \ge t' \;\text{and}\; u \le u'
$$

This follows from the ratio formulation of $\preceq$,
$$
    t\!:\!u + 1\!:\!0 \preceq t\!:\!u \preceq t\!:\!u + 0\!:\!1 \quad \forall\; t\!:\!u \in R.
$$

In $Q$, this translates to,
$$
\frac{t}{n} \preceq \frac{t'}{n'} \iff t \ge t' + \max(0,n-n').
$$

## Extending $\preceq$ to [full] tallies in $Q^D$

* WLOG, consider $D=2$

* Pharmacologic monotonicity engenders *logical implications*
  - $\left(\frac{1}{1},\frac{0}{0}\right) \implies \left(\frac{0}{0},\frac{1}{1}\right) \quad \text{or} \quad \left(\frac{1}{1},\frac{0}{0}\right) \supseteq \left(\frac{0}{0},\frac{1}{1}\right)$
  - $\left(\frac{0}{1},\frac{0}{0}\right) \impliedby \left(\frac{0}{0},\frac{0}{1}\right) \quad \text{or} \quad \left(\frac{0}{1},\frac{0}{0}\right) \subseteq \left(\frac{0}{0},\frac{0}{1}\right)$

* Since toxicities are bad and non-toxicities good, we have
  - $\left(\frac{1}{1},\frac{0}{0}\right) \preceq \left(\frac{0}{0},\frac{1}{1}\right)$ (RHS has less evidence of a *bad* thing)
  - $\left(\frac{0}{1},\frac{0}{0}\right) \preceq \left(\frac{0}{0},\frac{0}{1}\right)$ (LHS has less evidence of a *good* thing)

## Embracing 'arrows' qua 'narrative'

One talks of "applying" a function to an argument, of a function
"acting" on a domain.  There is a definite impression of action,
even of motion, as evidenced by the use of the arrow symbol, the
source-target terminology, and commonly used synonyms for "function"
like "transformation" and "mapping".  ...  **This dynamical quality
that we have been describing is an essential part of the meaning of the
word "function" as it is used in mathematics.**  The "ordered-pairs"
definition does not convey this.

::: aside
Robert Goldblatt. *Topoi: The Categorial Analysis of Logic.* Dover edition, 2006.
:::

## Breaking the x|o symmetry

* Claim: $\left(\frac{1}{1},\frac{0}{1}\right) \preceq \left(\frac{0}{1},\frac{1}{1}\right)$

```{.verbatim code-line-numbers="1-4|6-9|"}
Pt ID     A B C  D E F
Level 2          x o x |  2/3
Level 1   o o o        |  0/3
Cohort#     1      2   | Tally = [0/3,2/3] 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Pt ID     A B D  C E F
Level 2          o o x |  1/3
Level 1   o o x        |  1/3
Cohort#     1      2   | Tally = [1/3,1/3] 
```

::: {.incremental}
* $\left(\frac{1}{3},\frac{1}{3}\right) \preceq \left(\frac{0}{3},\frac{2}{3}\right)$
* $q + \left(\frac{1}{1},\frac{0}{1}\right) \preceq_\text{exch} \left(\frac{0}{1},\frac{1}{1}\right) + q$, where $q = \left(\frac{0}{2},\frac{1}{2}\right) \in Q^2$
:::

## Notation

For $q, q' \in Q$ and $j, k \in \{1,...,D\}$ we write:

* $\langle q \rangle_j := (\frac{0}{0},\dots,\frac{0}{0},q,\frac{0}{0},...,\frac{0}{0}) \in Q^D, \;q$ in $j$'th position

* $\langle q, q' \rangle_{j,k} := \langle q \rangle_j + \langle q' \rangle_k,$ with $j < k$ understood.

---

### Arrows of the *monoidal* preorder $(Q^D,\preceq)$

\begin{align*}
q + \langle\frac{1}{1},\frac{0}{1}\rangle_{j,k} &\preceq_{exch} \langle\frac{0}{1},\frac{1}{1}\rangle_{j,k} + q \quad \forall q \in Q^2, j<k \in \{1,...,D\}
\\
q + \langle\frac{1}{1}\rangle_j &\preceq_{-tox} \langle\frac{0}{0}\rangle_j + q
\\
q +  \langle\frac{0}{0}\rangle_j &\preceq_{tol+} \langle\frac{0}{1}\rangle_j + q
\\
q +  \langle\frac{0}{1}\rangle_j &\preceq_{titr} \langle\frac{0}{1}\rangle_{j+1} + q
\end{align*}

Transitive closure of $\preceq_{exch} \cup \preceq_{-tox} \cup \preceq_{tol+} \cup \preceq_{titr}$ is $\preceq$.

---

## More parsimony is possible

``` {.tikz}
%%| width: 100%
%%| height: 40%
\begin{tikzcd}
    (\frac{1}{1},\frac{0}{1}) \ar[r, "\preceq_\text{exch}"]
    \ar[rrr,bend right,"\preceq_{\text{-tox}_1}"']
    & (\frac{0}{1},\frac{1}{1}) \ar[r, "\preceq_\text{titr}"]
    & (\frac{0}{0},\frac{1}{2}) \ar[r, "\preceq_{\text{-tox}_2}"]
    & (\frac{0}{0},\frac{0}{1})
\end{tikzcd}
```

---

### Monoidal 'borrowing'?

\begin{align*}
\left(\frac{1}{1},\frac{0}{1}\right) &\preceq_{exch}\left(\frac{0}{1},\frac{1}{1}\right)
\\
+ \left(\frac{0}{1},\frac{0}{0}\right) &\preceq_{titr}\;\left(\frac{0}{0},\frac{0}{1}\right)
\\
\hline \\
\left(\frac{1}{2},\frac{0}{1}\right) &\;\;\preceq\;\; \left(\frac{0}{1},\frac{1}{2}\right)
\\
\left(\frac{0}{1},\frac{0}{1}\right) + \left(\frac{1}{1},\frac{0}{0}\right) & \;\;\preceq\;\; \left(\frac{0}{0},\frac{1}{1}\right) + \left(\frac{0}{1},\frac{0}{1}\right)
\end{align*}

---

> Make no mistake about it: Computers process numbers --- not symbols.
> We measure our understanding (and control) by the extent to which
> we can arithmetize an activity.
> 
> --- Alan J. Perlis (Epigram #65)

::: {.incremental}
* Not so much anti-symbolic-computing ..
* .. as pro-CLP(ℤ)!
:::

## Implementation (1)

```prolog
intlist_partsums([X|Xs], [X|Ss]) :-
    same_length(Xs, Ss), % eliminate unnecessary choice point
    intlist_partsums_acc(Xs, Ss, X).

intlist_partsums_acc([], [], _).
intlist_partsums_acc([X|Xs], [S|Ss], A) :-
    #S #= #X + #A,
    intlist_partsums_acc(Xs, Ss, S).

qs_Ts_Üs(Qs, ΣTs, ΣÜs) :-
    maplist(\Q^T^U^(q_r(Q, T:U)), Qs, Ts, Us),
    intlist_partsums(Ts, ΣTs),
    reverse(Us, Üs),
    intlist_partsums(Üs, RΣÜs),
    reverse(RΣÜs, ΣÜs).

%?- Qs = [1/6,2/6], maplist(q_r, Qs, Rs), qs_Ts_Üs(Qs, Ts, Üs).
%@    Qs = [1/6,2/6], Rs = [1:5,2:4], Ts = [1,3], Üs = [9,4].
```

## Implementation (2)

```prolog
'≼'(Q1s, Q2s, Truth) :-
    qs_Ts_Üs(Q1s, T1s, Ü1s),
    qs_Ts_Üs(Q2s, T2s, Ü2s),
    Ü1s = [Ü1|Ü1rs], Ü2s = [Ü2|Ü2rs],
    % We next calculate the _smallest_ exchange-adjustment As : Ü1s ⟼ Ü1as
    % that would ensure Ü1as ≤ Ü2s.  (In case this inequality already holds
    % as for unadjusted Ü1s, then this will be the _null_ adjustment.)
    same_length(Ü1rs, As),
    maplist(\A^U1^U2^(#A #= max(0, #U1 - #U2)), As, Ü1rs, Ü2rs),
    % Now we will calculate post-exchange [T1a|T1as] vector.
    as_Ts_Tas(As, T1s, T1as),
    if_((clpz_t(#Ü1 #=< #Ü2), % Q1 must not have _net_ advantage of more total o's
         T2s '≤' T1as % Even *after* exchange-adjustment, T1 must still exceed T2.
         % (Happily, the above also ensures T1as never 'goes negative'.)
        ),
        Truth = true,
        Truth = false
       ).
```

# Testing Ti*k*Z
``` {.tikz}
%%| width: 50%
%%| height: 50%
\begin{tikzcd}
    {\mathcal{M}} \ar[rr,hook]
    & & {\mathcal{N}} \ar[ll,bend left,"\Sigma"]
\end{tikzcd}
```


# Checking preamble ...

$$
\Q \xrightarrow{E} \D.
$$


# This embeds 2 intutitions:

* We are dealing with an *ordered set* of doses
* The current dose changes *incrementally*


# Pending work

# Thank you!
